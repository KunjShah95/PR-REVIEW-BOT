version: '3.9'

services:
  # Production Sentinel service
  sentinel:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: sentinel-cli:latest
    container_name: sentinel-review
    environment:
      - NODE_ENV=production
      # API Keys - set these in your .env file or environment
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      # Mount your project for analysis
      - ./:/workspace:ro
      # Persist reports
      - ./reports:/app/reports
      # Persist cache for AI responses
      - ./cache:/app/cache
    working_dir: /workspace
    command: ["analyze", "--format", "console"]

  # Development Sentinel service with hot reload
  sentinel-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    image: sentinel-cli:dev
    container_name: sentinel-dev
    environment:
      - NODE_ENV=development
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      - ./:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    command: ["npm", "run", "dev"]

  # CI-specific service for automated reviews
  sentinel-ci:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: sentinel-cli:ci
    container_name: sentinel-ci
    environment:
      - NODE_ENV=production
      - CI=true
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
    volumes:
      - ./:/workspace:ro
      - ./reports:/app/reports
    working_dir: /workspace
    command: ["analyze", "--format", "json", "--output", "/app/reports/code-review.json"]
